{"version":3,"file":"qbank_modal.min.js","sources":["../src/qbank_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_capquiz\n * @author     Sebastian Gundersen <sebastian@sgundersen.com>\n * @copyright  2024 Norwegian University of Science and Technology (NTNU)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\"use strict\";\n\nimport Modal from 'core/modal';\nimport * as ModalEvents from 'core/modal_events';\nimport * as FormChangeChecker from 'core_form/changechecker';\nimport * as Fragment from 'core/fragment';\nimport {getStrings} from 'core/str';\nimport AutoComplete from 'core/form-autocomplete';\n\nexport class QuestionBankModal extends Modal {\n    /**\n     * @param {Object} modalConfig\n     */\n    configure(modalConfig) {\n        modalConfig.large = true;\n        modalConfig.show = true;\n        modalConfig.removeOnClose = true;\n        this.contextId = modalConfig.contextId;\n        this.quizCmId = modalConfig.quizCmId;\n        this.bankCmId = modalConfig.bankCmId;\n        this.originalTitle = modalConfig.title;\n        super.configure(modalConfig);\n    }\n\n    /**\n     * Display this modal.\n     *\n     * @returns {Promise}\n     */\n    show() {\n        this.reloadBodyContent(window.location.search);\n        return super.show();\n    }\n\n    /**\n     * Reloady body content.\n     */\n    reloadBodyContent() {\n        this.hideFooter();\n        this.setTitle(this.originalTitle);\n        this.setBody(Fragment.loadFragment('mod_capquiz', 'capquiz_qbank', this.contextId, {\n            querystring: window.location.search,\n            quizcmid: this.quizCmId,\n            bankcmid: this.bankCmId,\n        }));\n    }\n\n    /**\n     * Register event listeners.\n     */\n    registerEventListeners() {\n        super.registerEventListeners(this);\n\n        this.getModal().on('click', 'button[data-action=\"switch-question-bank\"]', async() => {\n            await this.handleSwitchBankContentReload('#searchbanks');\n            const searchBanks = document.getElementById('searchbanks');\n            if (searchBanks instanceof HTMLElement) {\n                searchBanks.addEventListener('change', event => {\n                    const bankCmId = event.currentTarget.value;\n                    if (bankCmId > 0) {\n                        this.bankCmId = bankCmId;\n                        this.reloadBodyContent(window.location.search);\n                    }\n                });\n            }\n            const goBackButton = document.querySelector('button[data-action=\"go-back\"]');\n            if (goBackButton instanceof HTMLButtonElement) {\n                goBackButton.addEventListener('click', event => {\n                    this.bankCmId = event.currentTarget.value;\n                    this.reloadBodyContent(window.location.search);\n                });\n            }\n        });\n\n        this.getModal().on('click', 'a', event => {\n            const target = event.currentTarget;\n            if (!(target instanceof HTMLAnchorElement)) {\n                return;\n            }\n            if (target.closest('td.capquiz_add_question')) {\n                return;\n            }\n            if (target.closest('td.capquiz_preview_question')) {\n                return;\n            }\n            if (target.closest('.sorters')) {\n                return;\n            }\n            if (target.closest('a[data-newmodid]')) {\n                this.bankCmId = target.dataset.newmodid;\n\n                // We need to clear the filter as we are about to reload the content.\n                const url = new URL(location.href);\n                url.searchParams.delete('filter');\n                history.pushState({}, '', url);\n            }\n            event.preventDefault();\n            this.reloadBodyContent(target.search);\n        });\n\n        this.getModal().on('submit', 'form#questionsubmit', event => {\n            const form = event.currentTarget;\n            const cmIdInput = document.querySelector('form#questionsubmit input[name=\"cmid\"]');\n            cmIdInput.setAttribute('value', this.quizCmId);\n            const actionUrl = new URL(form.getAttribute('action'));\n            actionUrl.searchParams.set('cmid', this.quizCmId);\n            form.setAttribute('action', actionUrl.toString());\n        });\n\n        this.getRoot().on(ModalEvents.bodyRendered, () => {\n            FormChangeChecker.disableAllChecks();\n        });\n    }\n\n    /**\n     * Update the modal with a list of banks to switch to and enhance the standard selects to Autocomplete fields.\n     *\n     * Please note that this is copied from quiz/add_question_modal.js\n     *\n     * @param {String} selector for the original select element.\n     */\n    async handleSwitchBankContentReload(selector) {\n        const [selectQuestionBank, placeholderString, goBackString] = await getStrings([\n            {key: 'selectquestionbank', component: 'mod_quiz'},\n            {key: 'searchbyname', component: 'mod_quiz'},\n            {key: 'gobacktoquiz', component: 'mod_quiz'},\n        ]);\n\n        this.setTitle(selectQuestionBank);\n\n        // Create a 'Go back' button and set it in the footer.\n        const goBackButton = document.createElement('button');\n        goBackButton.classList.add('btn', 'btn-primary');\n        goBackButton.textContent = goBackString;\n        goBackButton.dataset.action = 'go-back';\n        goBackButton.value = this.bankCmId;\n        this.setFooter(goBackButton);\n\n        const bodyFragment = Fragment.loadFragment('mod_capquiz', 'switch_question_bank', this.contextId, {\n            quizcmid: this.quizCmId,\n            bankcmid: this.bankCmId,\n        });\n        this.setBody(bodyFragment);\n\n        await this.getBodyPromise();\n        await AutoComplete.enhance(\n            selector,\n            false,\n            'core_question/question_banks_datasource',\n            placeholderString,\n            false,\n            true,\n            '',\n            true\n        );\n\n        // Hide the selection element as we don't need it.\n        const selection = document.querySelector('.search-banks .form-autocomplete-selection');\n        if (selection instanceof HTMLElement) {\n            selection.classList.add('d-none');\n        }\n    }\n}\n\n/**\n * Initialize.\n *\n * @param {number} contextId\n * @param {number} quizCmId\n * @param {number} bankCmId\n */\nexport const init = (contextId, quizCmId, bankCmId) => {\n    QuestionBankModal.registerModalType();\n    document.addEventListener('click', async event => {\n        const target = event.target.closest('.menu [data-action=\"questionbank\"]');\n        if (target instanceof HTMLElement) {\n            event.preventDefault();\n            await QuestionBankModal.create({\n                contextId: contextId,\n                quizCmId: quizCmId,\n                bankCmId: bankCmId,\n                title: target.dataset.header,\n                templateContext: {\n                    hidden: true,\n                },\n            });\n        }\n    });\n};\n"],"names":["QuestionBankModal","Modal","configure","modalConfig","large","show","removeOnClose","contextId","quizCmId","bankCmId","originalTitle","title","reloadBodyContent","window","location","search","super","hideFooter","setTitle","this","setBody","Fragment","loadFragment","querystring","quizcmid","bankcmid","registerEventListeners","getModal","on","async","handleSwitchBankContentReload","searchBanks","document","getElementById","HTMLElement","addEventListener","event","currentTarget","value","goBackButton","querySelector","HTMLButtonElement","target","HTMLAnchorElement","closest","dataset","newmodid","url","URL","href","searchParams","delete","history","pushState","preventDefault","form","setAttribute","actionUrl","getAttribute","set","toString","getRoot","ModalEvents","bodyRendered","FormChangeChecker","disableAllChecks","selector","selectQuestionBank","placeholderString","goBackString","key","component","createElement","classList","add","textContent","action","setFooter","bodyFragment","getBodyPromise","AutoComplete","enhance","selection","registerModalType","create","header","templateContext","hidden"],"mappings":"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"}